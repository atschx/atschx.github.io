---
layout: post
title:  Think in Push
author: Albert
date:   2015-11-30 13:18:35
categories: tech
---

> Apple Push Notification service (APNs for short) is the centerpiece of the remote notifications feature. It is a robust and highly efficient service for propagating information to iOS and OS X devices. Each device establishes an accredited and encrypted IP connection with the service and receives notifications over this persistent connection. If a notification for an app arrives when that app is not running, the device alerts the user that the app has data waiting for it.
> 
> [see more](https://developer.apple.com/library/ios/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/Chapters/ApplePushService.html#//apple_ref/doc/uid/TP40008194-CH100-SW9)

![apns-workflow](https://developer.apple.com/library/ios/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/Art/remote_notif_simple_2x.png)

# 工作流程简述：

1. **Provider** 将包含`离线通知的报文t`提交到 APNs服务器(服务器后台负责维护与APNs的通讯工作)
2. **APNs** 将接收到的`报文`推送到具体的apple设备(APNs服务器负责与用户Apple设备的通讯工作)
3. **Apple设备** 负责接收来自APNs的通知并将其关联至已安装的某个App

> 在以上几个个环节中：
> 
> * 服务提供商可以`控制`将通知推送给哪些用户(`受众`)，因此需要管理用户的标识性信息(即**DeviceToken**)
> 
> 
> * APNs服务器需要**准确**地向一个具体的Apple设备推送通知(上一步必须告知DeviceToken)
> 
> 
> * Apple设备接收到通知后可以精确地跳转至具体的App(第一步也必须告知其App的BundleId）

# 实现APNS的正确姿势可分为以下几步：

1. 获取安装app的iphone设备Token信息
2. 按照APNs定义的协议与apple推送服务器通讯
3. 采用一些容错措施提高送达率

**服务承诺**：`best effort`.(这一点基本上对外声明，此服务只能用作在app未启动时有新的消息到达的提示性通知，但不可用作高实时性和一致性的场景)

## 获取用户设备的deviceToken

> 只有用户在安装某个app后点击允许接受push通知时，app服务商(`provider`)才能获取到DeviceToken。

![Sharing the device token](https://developer.apple.com/library/ios/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/Art/registration_sequence_2x.png)

## 服务提供商如何高效的与APNs通讯

> As a provider you communicate with Apple Push Notification service over a binary interface. This interface is a high-speed, high-capacity interface for providers; it uses a streaming TCP socket design in conjunction with binary content. The binary interface is asynchronous.
> 
> - 正式环境 gateway.push.apple.com, port 2195
> - 开发环境 gateway.sandbox.push.apple.com, port 2195

如何选择的第三方库？(Don't repeat yourself!)

如火如荼的开源社区，早已为`Provider`们封装好了一些第三方推送库（可谓是`前人栽树，后人乘凉`）。