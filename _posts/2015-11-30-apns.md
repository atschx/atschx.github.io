---
layout: post
title:  Think in Push
author: Albert
date:   2015-11-30 13:18:35
categories: tech
---

> Apple Push Notification service (APNs for short) is the centerpiece of the remote notifications feature. It is a robust and highly efficient service for propagating information to iOS and OS X devices. Each device establishes an accredited and encrypted IP connection with the service and receives notifications over this persistent connection. If a notification for an app arrives when that app is not running, the device alerts the user that the app has data waiting for it.
> [see more](https://developer.apple.com/library/ios/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/Chapters/ApplePushService.html#//apple_ref/doc/uid/TP40008194-CH100-SW9)

![apns-workflow](https://developer.apple.com/library/ios/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/Art/remote_notif_simple_2x.png)

工作方式：

1. Provider 将`离线通知`push到 APNs服务器
2. APNs根据将`离线通知`push给具体的apple设备
3. apple设备依据接收到的通知关联对应的App（点击通知中心的通知时打开对应的app）

> 在以上几个个环节中：
> - 服务提供商需要`控制`将通知push给哪些用户(`受众`)，因此需要对用户的标识性信息(即后面提到的**DeviceToken**)进行管理。
> - APNs服务器需要知道向哪个具体的设备进行推送，因此标识性信息中必须包含设备的唯一性信息(即设备串号UDID)
> - Apple设备接收到通知后需要知道具体的App，所以标识性信息中也必须包含App的唯一性信息（即BundleId）

# 实现APNS的正确姿势可分为以下几步：

1. 获取安装app的iphone设备Token信息
2. 按照APNs定义的协议与apple推送服务器通讯
3. 采用一些容错措施提高送达率

**服务承诺**：`best effort`.(这一点基本上对外声明，此服务只能用作在app未启动时有新的消息到达的提示性通知，但不可用作高实时性和一致性的场景)

## 获取用户设备的deviceToken

> 只有用户在安装某个app后点击允许接受push通知时，app服务商(`provider`)才能获取到DeviceToken。

![Sharing the device token](https://developer.apple.com/library/ios/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/Art/registration_sequence_2x.png)

## 服务提供商如何高效的与APNs通讯

> As a provider you communicate with Apple Push Notification service over a binary interface. This interface is a high-speed, high-capacity interface for providers; it uses a streaming TCP socket design in conjunction with binary content. The binary interface is asynchronous.
> - 正式环境 gateway.push.apple.com, port 2195
> - 开发环境 gateway.sandbox.push.apple.com, port 2195

如何选择的第三方库？(Don't repeat yourself!)

如火如荼的开源社区，早已为`Provider`们封装好了一些第三方推送库（可谓是`前人栽树，后人乘凉`）。
